# Index (目次)

1. [ドメイン名の対してルーティング先追加の基本的な操作](#基本的な操作)

2. [レコード作成画面 (クイック作成) の設定項目](#レコード作成画面-クイック作成-の設定項目)


3. [シンプルルーティングの設定方法](#シンプルルーティング)

4. [加重ルーティングの設定方法](#加重ルーティング)

5. [フェイルオーバールーティングの設定方法](#フェイルオーバールーティング)

6. [位置情報ルーティングの設定方法](#位置情報ルーティング)

7. [IPベースルーティングの設定方法](#ipベースルーティング)

8. [複数値回答ルーティングの設定方法](#複数値回答ルーティング)

---

### 基本的な操作

1. マネージドコンソールにログイン後、 Route53 画面に遷移し、サイドメニューの `ホストゾーン` をクリック

    <img src="./img/Route53_Routing_1.png" />

<br>

2. ルーティングを追加したいホストゾーンを選択し、ホストゾーンの詳細画面に遷移し、`レコードを作成` をクリックする

    - ★基本的に、作成済みの 2 レコード (NS & SOA) はいじらない

    <img src="./img/Route53_Routing_2.png" />

<br>

3. 基本的には A レコードを作成し、そのレコードに任意のルーティングポリシーを設定する

    - クイック作成画面 (デフォルト)

    <img src="./img/Route53_Routing_3.png" />

    <br>

    - ウィザード作成画面

    <img src="./img/Route53_Routing_4.png" />

<br>

#### DNS レコードについて

- [こちらのメモ](https://github.com/MasaGt/CS/blob/1613eb010b87df4b65d1d2f1eb0b2ff07ea96549/DNS%E3%83%AC%E3%82%B3%E3%83%BC%E3%83%89.md)を参照　

- [こちらの記事](https://blog.serverworks.co.jp/basic-knowledge-of-dns-records)も参考になる

<br>
<br>

参考サイト

[【初心者向け】DNSレコードの基本的な知識](https://blog.serverworks.co.jp/basic-knowledge-of-dns-records)

---

### レコード作成画面 (クイック作成) の設定項目

<img src="./img/Route53_Routing_3.png" />

<br>

- `レコード名`

    - サブドメインについてのレコードを作成したい場合、テキストボックスにサブドメインを入力する

<br>

- `レコードタイプ`

<br>

- `エイリアス`

    - レコードの値を IP アドレスではなく、リソースで設定するようにする項目

<br>

- `値`

    - 作成する DNS レコードの値

<br>

- `TTL`

    - このレコードのキャッシュ時間

    - DNS キャッシュサーバーにキャッシュされる時間

<br>

- `ルーティングポリシー`

    - ルーティング方法

<br>

#### エイリアスを有効にすると

<img src="./img/Route53_Routing_5.png" />

<br>

- `トラフィックのルーティング先`

    - その名の通り、ルーティング先

    - エンドポイントの種類、リージョン、リソースを選択して設定する

    <br>

    <img src="./img/Route53_Routing_6.png" />

<br>
<br>

参考サイト

[Route53にALBのレコードを追加　#487](https://note.com/ym202110/n/nf352554c9f81)

---

### [シンプルルーティング](./Route53.md#--シンプルルーティング)

1. ホストゾーンに A レコードを作成する

    - ルーティング先は EC2 のパブリックIP アドレスを選択した

        - EC2 アクセスした際に HTMLページが表示されるように index.htmlファイルを配置し、アパッチを起動している

    - ルーティングポリシーに`シンプルルーティング`を選択する

        - 複数のルーティング先を設定する場合は、 `値` のテキストエリアにて改行して次の IP アドレスを入力する

        <img src="./img/Route53-DNS-Record-Simple-Routing_1.png" />

<br>

2. nslookup や dig コマンドでドメイン名に IP アドレスが結び付けられているかを確認

    - dig コマンドでは、ANSWER SECTION の中でドメイン名に対するルーティング先 IP が正しく返ってきていれば OK

        <img src="./img/Route53-DNS-Record-Simple-Routing_2.png" />

    <br>

    - 今回は、htmlファイルを配置し、アパッチを起動した EC2 にドメインを結びつけたので、Web ブラウザでも確認してみる

        <img src="./img/Route53-DNS-Record-Simple-Routing_3.png" />

---

### [加重ルーティング](./Route53.md#--加重ルーティング)

1. ホストゾーンに A レコードを作成する

    - 2つのルーティング先のうちの1つへの A レコードを作成する

    - ルーティングポリシーに`加重`を選択する

        <img src="./img/Route53-DNS-Record-Weighted-Routing_1.png" />

    <br>

    - 残りのルーティング先への A レコードを作成する

    - ルーティングポリシーに`加重`を選択する

        <img src="./img/Route53-DNS-Record-Weighted-Routing_2.png" />

    <br>

    - `加重`
        - 対象のルーティング先へのリクエストの振り分け率

        - 詳しくは[こちら](#加重)を参照

    <br>

    - `ヘルスチェック`

        - 対象ルーティング先へのヘルスチェックを設定

    <br>

    - `レコード ID`
        - 対象の A レコードの識別子

        - 加重ルーティングでは同じレコード名の A レコードが2つ以上作成されるので、それぞれのレコードを識別するために、レコード ID を設定する必要がある

<br>

2. nslookup や dig コマンドでドメイン名に IP アドレスが結び付けられているかを確認

    - dig コマンドでは、ANSWER SECTION の中でドメイン名に対するルーティング先 IP が正しく返ってきていれば OK

    - 何回か dig コマンドで　問い合わせを行い、設定したルーティング先が設定した割合で返却されていれば OK

        <img src="./img/Route53-DNS-Record-Weighted-Routing_3.png" />

    <br>

    - 今回は、htmlファイルを配置し、アパッチを起動した 2つの EC2 にドメインを結びつけたので、Web ブラウザでも確認してみる

        - 対象先のルーティング先に設定した割合で接続できた

        <img src="./img/Route53-DNS-Record-Weighted-Routing_4.png" />

<br>

#### 加重

- リクエストを振り分ける比率

- `対象のレコードの加重値 / 全ての加重ルーティングレコードの加重値の合計` で各レコードの振り分け率が決まる

    ```
    例1: 2つのルーティング先それぞれ 50% の割合でリクエストを振り分けたい

    A: 2つのレコードの加重値を同じ値にすれば良い

    2つのレコードの加重にそれぞれ1を設定すると...
    それぞれのレコードへのトラフィックの重みは 1 / 2 = 50 %


    2つのレコードの加重にそれぞれ50を設定すると...
    それぞれのレコードへのトラフィックの重みは 50 / 100 = 50 %
    ```
    
    <br>

    ```
    例2: 2つのルーティング先を 8 : 2 の割合でリクエストを振り分けたい

    A:2つのレコードの加重の値が 4 : 1　になるように設定する

    1つのレコードの加重値を80
    もう1つのレコードの加重を20にすると...

        - 加重値80のレコードへのトラフィックの重みは 80 / 100 = 80 %

        - 加重値20のレコードへのトラフィックの重みは 20 / 100 = 20 %

    
    1つのレコードの加重値を8
    もう1つのレコードの加重を2にすると...

        - 加重値8のレコードへのトラフィックの重みは 8 / 10 = 80 %

        - 加重値2のレコードへのトラフィックの重みは 2 / 10 = 20 %
    ```

<br>

#### 注意点

- ルーティング先ごとに加重ルーティングポリシーの A レコードを作成する

    - [シンプルルーティング](#シンプルルーティング)のように、1つのレコードに複数のルーティング先を設定しないように注意する

---

### [フェイルオーバールーティング](./Route53.md#--フェイルオーバールーティング)

#### 今回の構成

<img src="./img/Route53-DNS-Record-Failover-Routing_1.png" />

#### 手順

1. EC2_A へのヘルスチェックの作成を行う

    - ヘルスチェックの作成についての詳細は[こちら](./Route53_ヘルスチェック作成.md)を参照

    <img src="./img/Route53-DNS-Record-Failover-Routing_2.png" />

<br>

2. 同様に EC2_B へのヘルスチェックの作成を行う (オプショナル)

    <img src="./img/Route53-DNS-Record-Failover-Routing_3.png" />

<br>

3. ヘルスチェックの結果が正常であることを確認する

    <img src="./img/Route53-DNS-Record-Failover-Routing_4.png" />

<br>

4. ホストゾーンにフェイルオーバールーティングの A レコードを作成する

    <img src="./img/Route53-DNS-Record-Failover-Routing_5.png" />

    <br>

    - `フェイルオーバーレコードタイプ`

        - 当レコードのルーティング先がプライマリかセカンダリのどちらなのかを設定する
    
    <br>

    - `ヘルスチェック ID`

        - フェイルオーバー検知のためのヘルスチェックを指定する

<br>

5. nslookup や dig コマンドでドメイン名に**プライマリの IP アドレス**が結び付けられているかを確認

    - dig コマンドでのドメイン名に紐づく IP アドレスを問い合わせると、プライマリ (EC2_A) の グローバル IP アドレスが返ってくることが確認できる

        <img src="./img/Route53-DNS-Record-Failover-Routing_6.png" />

    <br>

    - ブラウザでドメイン名にアクセスしてみると、プライマリ (EC2_A) に配置した index.html が表示されることが確認できる

        <img src="./img/Route53-DNS-Record-Failover-Routing_7.png" />


<br>

#### フェイルオーバーが正しく起きるか確認

<img src="./img/Route53-DNS-Record-Failover-Routing_14.png" />

<br>

1. プライマリ (EC2_A) で障害を起こしてみる

    - EC2_A へのヘルスチェックで異常を検知させるには以下のような方法がある

        - EC2_A を停止する

        - EC2_A へのヘルスチェックステータスを反転させる

        - EC2_A で動いている Apache を停止する (今回の EC2_A へのヘルスチェックは :80/index.html を見に行ってるから)
    
<br>

2. 上記の方法のうちどれかでプライマリへのヘルスチェックに異常を検知させる

    <img src="./img/Route53-DNS-Record-Failover-Routing_8.png" />

<br>

3. nslookup や dig コマンドでドメイン名に**セカンダリの IP アドレス**が結び付けられているかを確認

    - dig コマンドでのドメイン名に紐づく IP アドレスを問い合わせると、**セカンダリ (EC2_B) の グローバル IP アドレス**が返ってくることが確認できる

        <img src="./img/Route53-DNS-Record-Failover-Routing_9.png" />

    <br>

    - ブラウザでドメイン名にアクセスしてみると、**セカンダリ (EC2_B)** に配置した index.html が表示されることが確認できる

        <img src="./img/Route53-DNS-Record-Failover-Routing_10.png" />

<br>

#### プライマリが障害から回復した時の挙動

[フェイルオーバーが正しく起きるか確認](#フェイルオーバーが正しく起きるか確認)の続き

<img src="./img/Route53-DNS-Record-Failover-Routing_15.png" />

<br>

1. プライマリを復旧する

    <img src="./img/Route53-DNS-Record-Failover-Routing_11.png" />

<br>

2. nslookup や dig コマンドでドメイン名に**プライマリの IP アドレス**が結び付けられているかを確認

    - dig コマンドでのドメイン名に紐づく IP アドレスを問い合わせると、**プライマリ (EC2_A) の グローバル IP アドレス**が返ってくることが確認できる

        <img src="./img/Route53-DNS-Record-Failover-Routing_12.png" />

    <br>

    - ブラウザでドメイン名にアクセスしてみると、**プライマリ (EC2_A)** に配置した index.html が表示されることが確認できる

        <img src="./img/Route53-DNS-Record-Failover-Routing_13.png" />

<br>

#### ポイント

- プライマリ、セカンダリ全てのエンドポイントで障害が発生した場合

    - プライマリがルーティング先になる
    
    <img src="./img/Route53-DNS-Record-Failover-Routing-Point_1.png" />

<br>

#### 注意点

- プライマリに障害が起きても、すぐにルーティング先が切り替わるわけではない

    - プライマリへのヘルスチェックが異常を検知するまではプライマリへルーティングされる

<br>
<br>

参考サイト

プライマリ、セカンダリ全てのエンドポイントで障害が発生した場合の挙動について
- [Route 53 フェイルオーバールーティングポリシーの問題をトラブルシューティングする方法を教えてください。](https://repost.aws/ja/knowledge-center/route-53-fix-failover-policy-errors)

---

### [位置情報ルーティング](./Route53.md#--レイテンシールーティング)

#### 今回の構成

<br>

#### 手順

---

### [IPベースルーティング](./Route53.md#--ipベースルーティングポリシー)

#### 今回の構成

<br>

#### 手順

---

###  [複数値回答ルーティング](./Route53.md#--複数値回答ルーティングポリシー)

#### 今回の構成

<br>

#### 手順